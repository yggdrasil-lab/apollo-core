services:
  plex:
    image: plexinc/pms-docker:latest
    hostname: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
      - PLEX_CLAIM
    volumes:
      - /opt/apollo-core/plex:/config
      - /mnt/storage/media:/media
      - /tmp:/transcode
    ports:
      - target: 32400
        published: 32400
        mode: host # Host mode for DLNA/local discovery potential, though standard ingress is often safer in pure swarm. User mentioned "unless DLNA is needed", keeping options open but aiming for reachable via IP.
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.plex.rule=Host(`plex.${DOMAIN_NAME}`)"
        - "traefik.http.routers.plex.entrypoints=websecure"
        - "traefik.http.routers.plex.tls=true"
        - "traefik.http.services.plex.loadbalancer.server.port=32400"
    networks:
      - aether-net

  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/jellyfin:/config
      - /mnt/storage/media:/media
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN_NAME}`)"
        - "traefik.http.routers.jellyfin.entrypoints=websecure"
        - "traefik.http.routers.jellyfin.tls=true"
        - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    networks:
      - aether-net

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/tautulli:/config
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.role == manager" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.tautulli.rule=Host(`tautulli.${DOMAIN_NAME}`)"
        - "traefik.http.routers.tautulli.entrypoints=websecure"
        - "traefik.http.routers.tautulli.middlewares=authelia"
        - "traefik.http.routers.tautulli.tls=true"
        - "traefik.http.services.tautulli.loadbalancer.server.port=8181"
    networks:
      - aether-net

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/sonarr:/config
      - /mnt/storage/media:/media # Access to series
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/backups/apollo/sonarr:/config/Backups
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sonarr.rule=Host(`sonarr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.sonarr.entrypoints=websecure"
        - "traefik.http.routers.sonarr.middlewares=authelia"
        - "traefik.http.routers.sonarr.tls=true"
        - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
    networks:
      - aether-net

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/radarr:/config
      - /mnt/storage/media:/media # Access to movies
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/backups/apollo/radarr:/config/Backups
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.radarr.rule=Host(`radarr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.radarr.entrypoints=websecure"
        - "traefik.http.routers.radarr.middlewares=authelia"
        - "traefik.http.routers.radarr.tls=true"
        - "traefik.http.services.radarr.loadbalancer.server.port=7878"
    networks:
      - aether-net

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/lidarr:/config
      - /mnt/storage/media:/media # Access to music
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/backups/apollo/lidarr:/config/Backups
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.lidarr.rule=Host(`lidarr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.lidarr.entrypoints=websecure"
        - "traefik.http.routers.lidarr.middlewares=authelia"
        - "traefik.http.routers.lidarr.tls=true"
        - "traefik.http.services.lidarr.loadbalancer.server.port=8686"
    networks:
      - aether-net

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/prowlarr:/config
      - /mnt/storage/backups/apollo/prowlarr:/config/Backups
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.role == manager" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.prowlarr.entrypoints=websecure"
        - "traefik.http.routers.prowlarr.middlewares=authelia"
        - "traefik.http.routers.prowlarr.tls=true"
        - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
    networks:
      - aether-net

  overseerr:
    image: sctx/overseerr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/overseerr:/app/config
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.role == manager" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.overseerr.rule=Host(`overseerr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.overseerr.entrypoints=websecure"
        - "traefik.http.routers.overseerr.tls=true"
        - "traefik.http.services.overseerr.loadbalancer.server.port=5055"
    networks:
      - aether-net

  jellyseerr:
    image: fallenbagel/jellyseerr:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/jellyseerr:/app/config
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.role == manager" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.${DOMAIN_NAME}`)"
        - "traefik.http.routers.jellyseerr.entrypoints=websecure"
        - "traefik.http.routers.jellyseerr.tls=true"
        - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
    networks:
      - aether-net

  lazylibrarian:
    image: lscr.io/linuxserver/lazylibrarian:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/lazylibrarian:/config
      - /mnt/storage/media:/media # Access to Audiobooks
      - /mnt/storage/downloads:/downloads # Access to Downloads
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.lazylibrarian.rule=Host(`lazylibrarian.${DOMAIN_NAME}`)"
        - "traefik.http.routers.lazylibrarian.entrypoints=websecure"
        - "traefik.http.routers.lazylibrarian.middlewares=authelia"
        - "traefik.http.routers.lazylibrarian.tls=true"
        - "traefik.http.services.lazylibrarian.loadbalancer.server.port=5299"
    networks:
      - aether-net

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Pacific/Auckland
    volumes:
      - /opt/apollo-core/audiobookshelf:/config
      - /mnt/storage/media:/media
      - /mnt/storage/backups/apollo/audiobookshelf:/metadata/backups
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.audiobookshelf.rule=Host(`audiobooks.${DOMAIN_NAME}`)"
        - "traefik.http.routers.audiobookshelf.entrypoints=websecure"
        - "traefik.http.routers.audiobookshelf.tls=true"
        - "traefik.http.services.audiobookshelf.loadbalancer.server.port=80"
    networks:
      - aether-net

  metube:
    image: ghcr.io/alexta69/metube:latest
    environment:
      - UID=1000
      - GID=1000
      - TZ=Pacific/Auckland
      - YTDL_OPTIONS={"extractor_args":{"youtube":{"player_client":["android","web"]}}}
    volumes:
      - /mnt/storage/media/Youtube:/downloads
    labels:
      - "com.docker.compose.project=${STACK_NAME}"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ "node.hostname == muspelheim" ]
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.metube.rule=Host(`youtube.${DOMAIN_NAME}`)"
        - "traefik.http.routers.metube.entrypoints=websecure"
        - "traefik.http.routers.metube.middlewares=authelia"
        - "traefik.http.routers.metube.tls=true"
        - "traefik.http.services.metube.loadbalancer.server.port=8081"
    networks:
      - aether-net

networks:
  aether-net:
    external: true
